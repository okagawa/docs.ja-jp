---
title: External RuleSet Toolkit
ms.date: 03/30/2017
ms.assetid: a306d283-a031-475e-aa01-9ae86e7adcb0
ms.openlocfilehash: eb59b02d469788b23126f4e02c5b7ae5a63081f0
ms.sourcegitcommit: 011314e0c8eb4cf4a11d92078f58176c8c3efd2d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/09/2020
ms.locfileid: "77094671"
---
# <a name="external-ruleset-toolkit"></a>External RuleSet Toolkit

通常、ワークフロー アプリケーション内でルールが使用される場合は、そのルールはアセンブリの一部です。 場合によっては、ワークフロー アセンブリのリビルドや配置を行わずに RuleSet を更新できるように、RuleSet をアセンブリとは別に管理することもあります。 このサンプルでは、RuleSet をデータベース内で管理および編集し、実行時にそれらの RuleSet にワークフローからアクセスできるようにしています。 その結果、実行中のワークフロー インスタンスに、RuleSet への変更を自動的に組み込むことができます。

この External RuleSet Toolkit サンプルには、RuleSet のバージョンをデータベース内で管理および編集するために使用できる Windows フォーム ベースのツールが含まれています。 また、このようなルールを実行するためのアクティビティとホスト サービスも含まれます。

> [!NOTE]
> このサンプルには[Microsoft SQL Server](/sql)が必要です。

Visual Studio には、Windows Workflow Foundation (WF) の一部としてルールセットエディターが用意されています。 このエディタは、ワークフロー内の `Policy` アクティビティをダブルクリックすると起動できます。これにより、定義済みの RuleSet オブジェクトが、ワークフローに関連付けられている .rules ファイルにシリアル化されます (`Policy` アクティビティにより、ワークフローに対して RuleSet インスタンスが実行されます)。 .rules ファイルは、ワークフロー プロジェクトをビルドするときに、リソースとしてアセンブリにコンパイルされます。

このサンプルは、次のコンポーネントで構成されています。

- RuleSet のバージョンをデータベース内で編集および管理するために使用できる RuleSet グラフィカル ユーザー インターフェイス ツール。

- ホスト アプリケーション上で構成され、データベースから RuleSet にアクセスする RuleSet サービス。

- RuleSet サービスから RuleSet を要求し、その RuleSet をワークフローに対して実行する `ExternalPolicy` アクティビティ。

次の図は、コンポーネントの相互作用を示しています。 図の後で各コンポーネントについて説明します。

![外部のルールセットツールキットのサンプルの概要を示す図](./media/external-ruleset-toolkit/ruleset-toolkit-overview.gif)

> [!IMPORTANT]
> サンプルは、既にコンピューターにインストールされている場合があります。 続行する前に、次の (既定の) ディレクトリを確認してください。
>
> `<InstallDrive>:\WF_WCF_Samples`
>
> このディレクトリが存在しない場合は、 [Windows Communication Foundation (wcf) および Windows Workflow Foundation (WF) のサンプルの .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459)にアクセスして、すべての WINDOWS COMMUNICATION FOUNDATION (wcf) と [!INCLUDE[wf1](../../../../includes/wf1-md.md)] サンプルをダウンロードしてください。 このサンプルは、次のディレクトリに格納されます。
>
> `<InstallDrive>:\WF_WCF_Samples\WF\Scenario\ExternalRuleSetToolKit`

## <a name="ruleset-tool"></a>RuleSet ツール

次の図は、ルールセットツールのスクリーンショットです。 **[ルールストア]** メニューから、データベースから使用可能なルールセットを読み込んで、変更されたルールセットをストアに保存し直すことができます。 RuleSet データベースのデータベース接続文字列は、アプリケーション構成ファイルで指定されます。 ツールを起動すると、構成済みのデータベースから自動的に RuleSet が読み込まれます。

![ルールセットブラウザーを示すスクリーンショット。](./media/external-ruleset-toolkit/ruleset-browser-dialog.gif)

RuleSet ツールでは、RuleSet にメジャー バージョン番号とマイナー バージョン番号を割り当てます。これにより、複数のバージョンを同時に管理および保存できます (ツールには、バージョン管理機能以外に、ロックなどの構成管理機能は用意されていません)。 このツールを使用して、新しいバージョンの RuleSet を作成したり、既存のバージョンを削除したりできます。 **[新規]** をクリックすると、新しいルールセット名が作成され、バージョン1.0 が適用されます。 バージョンをコピーすると、含まれているルールを含め、選択した RuleSet バージョンのコピーが作成されて、新しい一意のバージョン番号が割り当てられます。 これらのバージョン番号は、既存の RuleSet のバージョン番号を基に割り当てられます。 RuleSet 名とバージョン番号は、フォーム上の対応するフィールドを使用して変更できます。

[ルールの**編集**] をクリックすると、次の図に示すように、ルールセットエディターが開始されます。

![ルールセットエディターを示すスクリーンショット。](./media/external-ruleset-toolkit/ruleset-editor-dialog.gif)

これは、Visual Studio アドイン Windows Workflow Foundation の一部であるエディターダイアログの再ホストです。 そのため、Intellisense サポートを含めて、同等の機能が用意されています。 規則は、ツールのルールセットに関連付けられている対象の型 (ワークフローなど) に対して作成されます。メインツールダイアログの **[参照]** をクリックすると、図4に示すように、 **[ワークフロー/型セレクター]** ダイアログが表示されます。

![ワークフロー &#47;の種類の選択](./media/71f08d57-e8f2-499e-8151-ece2cbdcabfd.gif "71f08d57-e8f2-499 e-8151-ece2cbdcabfd")

図 4: UI-Workflow/Type Selector

**[ワークフロー/型セレクター]** ダイアログを使用して、アセンブリとそのアセンブリ内の特定の型を指定できます。 ルールの作成 (および実行) は、この型に対して行います。 多くの場合、対象となる型は、ワークフロー型または他の任意のアクティビティ型です。 ただし、RuleSet は任意の .NET 型に対して実行できます。

データベースでルールセットが取得されるときに、アセンブリファイルへのパスと種類 `name are stored with the` ルールセットをデータベースから取得すると、ツールは対象の型を自動的に読み込むように試みます。

**[ワークフロー/種類の選択]** ダイアログで **[OK]** をクリックすると、選択した種類がルールセットに対して検証され、対象の型に規則によって参照されるすべてのメンバーが含まれるようになります。 エラーは、 **[検証エラー]** ダイアログボックスに表示されます。 エラーが発生しても変更を続行するか、 **[キャンセル]** をクリックするかを選択できます。 メインツールダイアログの **[ツール]** メニューから **[検証]** をクリックして、対象アクティビティに対してルールセットのバージョンを再検証することができます。

![[検証エラー] ダイアログボックスが表示されているスクリーンショット。](./media/external-ruleset-toolkit/validation-errors-dialog.png)

ツールの **[データ]** メニューから、ルールセットをインポートおよびエクスポートできます。 **インポート** をクリックすると、ファイルの選択 ダイアログボックスが表示されます。このダイアログで、ルールファイルを選択できます。 これは、Visual Studio で最初に作成されたファイルである場合もあれば、存在しない場合もあります。 .rules ファイルは、条件のコレクションと RuleSet のコレクションを含む、シリアル化された `RuleDefinitions` インスタンスを保持します。 このツールでは、condition コレクションは使用されませんが、Visual Studio 環境との対話を可能にするために `RuleDefinitions` の形式が使用されます。

ルールファイルを選択すると、 **[ルールセットの選択]** ダイアログボックスが表示されます。 このダイアログ ボックスを使用して、インポートするファイルから RuleSet を選択できます (既定では、すべての RuleSet が指定されます)。 WF プロジェクト内の RuleSet のバージョンはアセンブリのバージョンと同じであるため、.rules ファイル内の RuleSet にはバージョン番号がありません。 インポート処理中に、ツールによって、次に使用可能なメジャーバージョン番号が自動的に割り当てられます (インポート後に変更できます)。割り当てられたバージョン番号は、 **[ルールセットの選択]** ボックスの一覧に表示されます。

ツールでは、インポートする RuleSet ごとに、RuleSet で使用されるメンバに基づいて、.rules ファイルの場所の下に bin\Debug フォルダー (存在する場合) から関連付けられている型が検索されます。 一致する型が複数見つかった場合は、.rules ファイル名と型名の対応関係に基づいて型が選択されます (たとえば、`Workflow1` 型は Workflow1.rules に対応します)。 対応関係が複数存在する場合は、型を選択するように求められます。 この自動識別機構が一致するアセンブリまたは型を見つけることができない場合は、メインツールダイアログの **[参照]** をクリックして、関連付けられている型に移動します。 次の図は、ルールセットセレクターを示しています。

![[ルールセットの選択] ダイアログボックスが表示されているスクリーンショット。](./media/external-ruleset-toolkit/ruleset-selector-dialog.gif)

メインツールメニューの **[データエクスポート]** をクリックすると、 **[ルールセットの選択]** ダイアログボックスが再び表示され、エクスポートするデータベースのルールセットを確認できます。 **[OK]** をクリックすると、 **[ファイルの保存]** ダイアログボックスが表示され、結果として生成されるルールファイルの名前と場所を指定できます。 .rules ファイルではバージョン情報が保持されないため、特定の RuleSet 名を持つ RuleSet バージョンを 1 つだけ選択することができます。

## <a name="policyfromservice-activity"></a>PolicyFromService アクティビティ

`PolicyFromService` アクティビティのコードは単純です。 このコードの動作は、WF で提供される `Policy` アクティビティによく似ていますが、.rules ファイルから対象の RuleSet を取得するのではなく、ホスト サービスを呼び出して RuleSet のインスタンスを取得します。 その後、ルートのワークフロー アクティビティ インスタンスに対して RuleSet を実行します。

ワークフロー内でこのアクティビティを使用するには、ワークフロー プロジェクトから `PolicyActivities` アセンブリおよび `RuleSetService` アセンブリへの参照を追加します。 ツールボックスにアクティビティを追加する方法については、このトピックの最後にある手順を参照してください。

ワークフロー内にアクティビティを配置したら、実行する RuleSet の名前を指定する必要があります。 この名前は、リテラル値として入力することも、他のアクティビティのワークフロー変数やプロパティにバインドすることもできます。 必要に応じて、実行する特定の RuleSet のバージョン番号を入力できます。 メジャー バージョン番号とマイナー バージョン番号を既定値の 0 のままにしておくと、データベース内の最新のバージョン番号が自動的にアクティビティに指定されます。

## <a name="ruleset-service"></a>ルールセット サービス

このサービスには、指定された RuleSet のバージョンをデータベースから取得し、呼び出し元のアクティビティに返す役割があります。 既に説明したように、`GetRuleSet` の呼び出しで渡されるメジャー バージョンとマイナー バージョンの値がどちらも 0 の場合は、最新のバージョンが取得されます。 現時点では、RuleSet の定義と RuleSet インスタンスはキャッシュされず、RuleSet のバージョンに "配置済み" というマークを付けて実行中の RuleSet と区別する機能もありません。

サービスからアクセスされるデータベースは、アプリケーション構成ファイルを使用してホストで構成する必要があります。

#### <a name="to-run-the-tool"></a>ツールを実行するには

1. ツールとサービスで使用される RuleSet テーブルを設定するフォルダには Setup.sql ファイルがあります。 Setup.cmd バッチ ファイルを実行して SQL Express 上に Rules データベースを作成して RuleSet テーブルを設定します。

2. このバッチ ファイルまたは Setup.sql を編集して、SQL Express を使用しないように指定した場合、または `Rules` 以外の名前のデータベースにテーブルを配置するように指定した場合は、RuleSet ツールのアプリケーション構成ファイルと `UsageSample` プロジェクトを同じ情報で編集する必要があります。

3. Setup.sql スクリプトを実行したら、`ExternalRuleSetToolkit` ソリューションをビルドし、その後 ExternalRuleSetTool プロジェクトから RuleSet ツールを起動できます。

4. `RuleSetToolkitUsageSample` のシーケンシャル ワークフロー コンソール アプリケーション ソリューションにはサンプル ワークフローが含まれています。 このワークフローは、`PolicyFromService` アクティビティ、および `orderValue` と `discount` の 2 つの変数で構成されており、対象の RuleSet はこれらに対して実行されます。

5. サンプルを使用するには `RuleSetToolkitUsageSample` ソリューションをビルドします。 次に、ルールセットツールのメインメニューから、 **[データのインポート]** をクリックし、RuleSetToolkitUsageSample フォルダー内の discountruleset.rules ファイルをポイントします。 **[ルールストア-保存]** メニューオプションをクリックして、インポートしたルールセットをデータベースに保存します。

6. `PolicyActivities` アセンブリがサンプル ワークフロー プロジェクトから参照されているため、`PolicyFromService` アクティビティがワークフロー内に表示されます。 ただし、既定ではツールボックスに表示されません。 ツールボックスに追加するには、次の手順を実行します。

    - ツールボックス を右クリックし、**項目の選択** を選択します (これには時間がかかる場合があります)。

    - **[ツールボックスアイテムの選択]** ダイアログボックスが表示されたら、 **[活動]** タブをクリックします。

    - `ExternalRuleSetToolkit` ソリューションで `PolicyActivities` アセンブリを参照し、 **[開く]** をクリックします。

    - **[ツールボックスアイテムの選択]** ダイアログで `PolicyFromService` アクティビティが選択されていることを確認し、 **[OK]** をクリックします。

    - これで、 **[RuleSetToolkitUsageSample Components]** カテゴリの [ツールボックス] にアクティビティが表示されます。

7. RuleSet サービスは、Program.cs 内の次のステートメントを使用して既にコンソール アプリケーション ホストで構成されています。

    ```csharp
    workflowRuntime.AddService(new RuleSetService());
    ```

8. 構成ファイルを使用して、ホストでこのサービスを構成することもできます。詳細については、SDK のドキュメントを参照してください。

9. アプリケーション構成ファイルがワークフロー プロジェクトに追加され、サービスが使用するデータベース接続文字列が指定されます。 この接続文字列は、RuleSet テーブルを含むデータベースを指す、RuleSet ツールが使用する接続文字列と同一である必要があります。

10. これで、`RuleSetToolkitUsageSample` プロジェクトを他のワークフロー コンソール アプリケーションと同様に実行できるようになります。 Visual Studio 内で F5 キーまたは Ctrl + F5 キーを押すか、RuleSetToolkitUsageSample ファイルを直接実行します。

    > [!NOTE]
    > RuleSet ツールは使用方法サンプルのアセンブリを読み込んでいるため、使用方法サンプルを再コンパイルするには RuleSet ツールを閉じる必要があります。

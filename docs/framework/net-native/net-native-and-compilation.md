---
title: .NET Native とコンパイル
ms.date: 03/30/2017
ms.assetid: e38ae4f3-3e3d-42c3-a4b8-db1aa9d84f85
ms.openlocfilehash: cf5c9f05b2f2cb4ca15e4add5b53bc9bdca757a3
ms.sourcegitcommit: b16c00371ea06398859ecd157defc81301c9070f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/06/2020
ms.locfileid: "73128242"
---
# <a name="net-native-and-compilation"></a>.NET Native とコンパイル

.NET Framework を対象にした Windows 8.1 アプリケーションと Windows デスクトップ アプリケーションは特定のプログラミング言語で記述し、中間言語 (IL: Intermediate Language) にコンパイルされます。 実行時には、メソッドが初めて実行される直前に JIT (Just-In-Time) コンパイラによって IL がローカル コンピューターのネイティブ コードにコンパイルされます。 それとは対照的に、.NET ネイティブ ツール チェーンでは、コンパイル時にソース コードをネイティブ コードに変換します。 このトピックでは、.NET ネイティブを、.NET Framework アプリをコンパイルする他のテクノロジと比較します。また、.NET ネイティブがネイティブ コードをどのように生成するのかについて実践的な概要を説明しますので、.NET ネイティブでコンパイルしたコードで発生する例外が JIT でコンパイルしたコードでは発生しない理由を理解するために役立ちます。

## <a name="net-native-generating-native-binaries"></a>.NET ネイティブ: ネイティブ バイナリを生成する

.NET Framework を対象にしていても、.NET ネイティブ ツール チェーンを使用してコンパイルされないアプリケーションは、次のようなアプリケーション アセンブリで構成されます。

- アセンブリ、その依存関係、それに含まれる型、そのメンバーを記述した[メタデータ](../../standard/metadata-and-self-describing-components.md)。 メタデータは、リフレクションと遅延バインディング アクセスのために使用され、場合によってはコンパイラとビルド ツールによって使用されることもあります。

- 実装コード。 これは、中間言語 (IL) オペコードで構成されます。 実行時には、JIT (Just-In-Time) コンパイラが IL コードを対象のプラットフォームのネイティブ コードに変換します。

 これらの主要なアプリケーション アセンブリに加えて、アプリは次の項目の存在を必要とします。

- アプリに必要な他のすべてクラス ライブラリまたはサード パーティ製のアセンブリ。 これらのアセンブリには、アプリと同様に、アセンブリ、その型、およびそのメンバーを記述したメタデータが含まれるほか、すべての型のメンバーを実装する IL が含まれます。

- .NET Framework クラス ライブラリ。 これは、.NET Framework のインストール時にローカル システムにインストールされるアセンブリのコレクションです。 .NET Framework クラス ライブラリに含まれるアセンブリには、メタデータと実装コードの完全なセットが含まれます。

- 共通言語ランタイム。 これは、アセンブリの読み込み、メモリ管理とガベージ コレクション、例外処理、JIT コンパイル、リモート処理、および相互運用機能などのサービスを実行するダイナミック リンク ライブラリのコレクションです。 クラス ライブラリと同様に、このランタイムは .NET Framework のインストールの一部としてローカル システムにインストールされます。

アプリを正常に実行するためには、共通言語ランタイム全体だけでなく、アプリケーション固有のアセンブリ、サード パーティ製のアセンブリ、およびシステム アセンブリに含まれるすべての型のメタデータと IL が存在している必要があることに注意してください。

## <a name="net-native-and-just-in-time-compilation"></a>.NET ネイティブと Just-In-Time コンパイル

.NET ネイティブ ツール チェーンへの入力は、C# または Visual Basic コンパイラでビルドされた Windows ストア アプリです。 したがって、.NET ネイティブ ツール チェーンの実行が開始されるのは、言語コンパイラが Windows ストア アプリのコンパイルを終了した時点です。

> [!TIP]
> .NET ネイティブへの入力は、マネージド アセンブリ向けに記述された IL とメタデータであるため、ビルド前またはビルド後のイベントを使用するか、または MSBuild プロジェクト ファイルを変更することにより、カスタム コードの生成やその他のカスタム操作を実行する余地があります。
>
> ただし、IL を変更する種類のツール、つまり .NET ツール チェーンがアプリの IL を解析することを妨げるツールはサポートされません。 難読化ツールは、この種類のツールとして代表的なものです。

アプリを IL からネイティブ コードに変換する過程で、.NET ネイティブ ツール チェーンは次のような操作を実行します。

- 特定のコード パスについて、リフレクションやメタデータに依存するコードを、静的なネイティブ コードで置き換えます。 たとえば、値型が <xref:System.ValueType.Equals%2A?displayProperty=nameWithType> メソッドをオーバーライドしない場合、等しいかどうかの既定のテストは、リフレクションを使用して値型のフィールドを表す <xref:System.Reflection.FieldInfo> オブジェクトを取得することによって行われるため、2 つのインスタンスのフィールド値の比較になります。 ネイティブ コードにコンパイルするとき、.NET ネイティブ ツール チェーンは、このリフレクションのコードとメタデータをフィールド値の静的な比較に置き換えます。

- 可能であれば、すべてのメタデータを削除しようとします。

- アプリにより実際に呼び出される実装コードのみを、最終的なアプリ アセンブリに組み込みます。 これによる効果は、特にサード パーティ製ライブラリや、.NET Framework クラス ライブラリの場合に発揮されます。 この操作の結果として、アプリケーションはサード パーティ製のライブラリにも完全な .NET Framework クラス ライブラリにも依存しなくなり、サード パーティ製のライブラリおよび .NET Framework クラス ライブラリに含まれるコードがアプリに対してローカルになります。

- 完全な CLR を、主としてガベージ コレクターを含む、リファクタリングされたランタイムに置き換えます。 リファクタリングされたランタイムは、アプリに対してローカルで、サイズがわずか数百キロバイトの mrt100_app.dll という名前のライブラリに含まれます。 これが可能になるのは、静的リンクを使用することにより、共通言語ランタイムによって実行されるサービスの多くが不要になるためです。

  > [!NOTE]
  > .NET ネイティブでは、標準の共通言語ランタイムと同じガベージ コレクターが使用されます。 .NET ネイティブのガベージ コレクターでは、既定でバックグラウンド ガベージ コレクションが既定で有効になります。 ガベージ コレクションの詳細については、「[ガベージ コレクションの基礎](../../standard/garbage-collection/fundamentals.md)」を参照してください。

> [!IMPORTANT]
> .NET ネイティブは、アプリケーション全体をネイティブ アプリケーションにコンパイルします。 ネイティブ コードに対するクラス ライブラリを含む 1 つのアセンブリをコンパイルして、マネージド コードから独立して呼び出せるようにすることはできません。

.NET ネイティブ ツール チェーンによって生成される結果のアプリは、プロジェクト ディレクトリの Debug または Release ディレクトリ内の ilc.out という名前のディレクトリに出力されます。 これは次のようなファイルで構成されます。

- *\<appName>*.exe。 `Main` .dll 内の特殊なエクスポートに制御を転送するだけのスタブ実行可能ファイルです。 *\<appName>*

- *\<appName>*.dll は、すべてのアプリケーションコードと、依存関係があるすべてのサードパーティ製ライブラリの .NET Framework コードを含む、すべてのアプリケーションコードを含む Windows ダイナミックリンクライブラリです。  さらに、たとえば Windows と相互運用するために必要なコードや、アプリ内のオブジェクトをシリアル化するために必要なコードなどのサポート コードも格納しています。

- mrt100_app.dll。リファクタリングしたランタイムであり、ガベージ コレクションなどのランタイム サービスを提供します。

 すべての依存関係は、アプリの APPX マニフェストによってキャプチャされます。  appx パッケージに直接バンドルされるアプリケーションの exe、dll、および mrt100_app.dll に加えて、さらに次の 2 つのファイルが含まれます。

- msvcr140_app.dll。mrt100_app.dll によって使用される C ランタイム (CRT) ライブラリです。 これはパッケージ内のフレームワーク参照によって組み込まれます。

- mrt100.dll。 mrt100_app.dll のパフォーマンスを向上させる関数が含まれるライブラリですが、このファイルが存在しなくても mrt100_app.dll は機能します。 これが存在する場合は、ローカル コンピューターの system32 ディレクトリから読み込まれます。

.NET ネイティブ ツール チェーンはアプリが実際に呼び出すことがわかっている実装コードのみをアプリにリンクするため、次のシナリオで必要なメタデータや実装コードはアプリに組み込まれないことがあります。

- リフレクション。

- 動的呼び出しまたは遅延バインディング呼び出し。

- シリアル化と逆シリアル化。

- COM 相互運用。

必要なメタデータや実装コードが実行時に存在しない場合は、.NET ネイティブ ランタイムが例外をスローします。 これらの例外を回避し、必要なメタデータと実装コードが .NET ネイティブ ツール チェーンによって組み込まれたことを確認するには、[ランタイム ディレクティブ ファイル](runtime-directives-rd-xml-configuration-file-reference.md)という XML ファイルを使用します。このファイルでは、実行時に利用可能であることが必要なメタデータまたは実装コードを含むプログラム要素を指定し、それらのプログラム要素にランタイム ポリシーを割り当てます。 .NET ネイティブ ツール チェーンでコンパイルした Windows ストア プロジェクトに追加される既定のランタイム ディレクティブ ファイルは次のとおりです。

```xml
<Directives xmlns="http://schemas.microsoft.com/netfx/2013/01/metadata">
  <Application>
    <Assembly Name="*Application*" Dynamic="Required All" />
  </Application>
</Directives>
```

これにより、アプリ パッケージ内のすべてのアセンブリに含まれるすべての型と、それに含まれるすべてのメンバーのリフレクションと動的呼び出しが可能になります。 ただし、.NET Framework クラス ライブラリ アセンブリに含まれる型のリフレクションと動的なアクティブ化は可能になりません。 多くの場合、これで十分です。

## <a name="net-native-and-ngen"></a>.NET ネイティブと NGEN

[ネイティブ イメージ ジェネレーター](../tools/ngen-exe-native-image-generator.md) (NGEN) は、アセンブリをネイティブ コードにコンパイルして、ローカル コンピューター上のネイティブ イメージ キャッシュにインストールします。 ただし、NGEN は、ネイティブ コードを生成するという点では .NET ネイティブと同じですが、いくつかの重要な点で .NET ネイティブと異なります。

- NGEN は、特定のメソッドのネイティブ イメージを利用できない場合に、コードの JIT 処理にフォールバックします。 このため、NGEN が JIT コンパイルにフォールバックする必要がある場合に備えて、メタデータと IL をネイティブ イメージに組み込んでおく必要があります。 これに対して、.NET ネイティブではネイティブ イメージのみが生成され、JIT コンパイルにフォールバックすることはありません。 その結果、一部のリフレクション、シリアル化、および相互運用機能のシナリオに必要なメタデータのみを保持すれは十分です。

- NGEN は、次に挙げるサービスについて完全な共通言語ランタイムに引き続き依存します。アセンブリの読み込み、リモート処理、相互運用性、メモリ管理、ガベージ コレクションなどと、必要な場合は JIT コンパイルです。 .NET ネイティブでは、これらのサービスの多くが不要か (JIT コンパイル)、ビルド時に解決されてアプリのアセンブリに組み込まれます。 これら以外のサービス (最も重要なものはガベージ コレクション) は、はるかに小さい、リファクタリングされた mrt100_app.dll という名前のランタイムに含まれています。

- NGEN イメージは、脆弱な傾向があります。 たとえば、依存関係のあるファイルにパッチや変更が適用された場合は、通常、それを使用するアセンブリも再度 NGEN で処理する必要があります。 このことは、特に .NET Framework クラス ライブラリに含まれるシステム アセンブリの場合に当てはまります。 これに対して、.NET ネイティブでは、アプリケーションがそれぞれ個別に実行されます。

## <a name="see-also"></a>関連項目

- [メタデータと自己言及的なコンポーネント](../../standard/metadata-and-self-describing-components.md)
- [インサイド .NET ネイティブ (Channel 9 ビデオ)](https://channel9.msdn.com/Shows/Going+Deep/Inside-NET-Native)
- [リフレクションおよび .NET ネイティブ](reflection-and-net-native.md)
- [.NET ネイティブの一般的なトラブルシューティング](net-native-general-troubleshooting.md)

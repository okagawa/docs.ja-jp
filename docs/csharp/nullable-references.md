---
title: null 許容参照型
description: この記事では、C# 8.0 で追加された null 許容参照型の概要を説明します。 新規および既存のプロジェクトにおいて、その機能によって null 参照例外に対する安全性がどのように提供されるかを学習します。
ms.technology: csharp-null-safety
ms.date: 02/19/2019
ms.openlocfilehash: ded7234ecb746ba03ba59505b7189272886f1cbf
ms.sourcegitcommit: 22be09204266253d45ece46f51cc6f080f2b3fd6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/07/2019
ms.locfileid: "73737835"
---
# <a name="nullable-reference-types"></a>null 許容参照型

C# 8.0 で導入された **null 許容参照型**および **null 非許容参照型**を使用すると、参照型変数のプロパティについて重要なことを表明できます。

- **参照が null になることはない**。 変数が null にならない場合、コンパイラでは最初に変数が null ではないことをチェックしないで変数を逆参照しても安全であることを保証する規則が適用されます。
  - 変数は、null 以外の値に初期化される必要があります。
  - 変数に値 `null` を割り当てることはできません。
- **参照は null になることがある**。 変数が null になる可能性がある場合、コンパイラでは別の規則が適用されて、null 参照を正しくチェックしていることが確認されます。
  - 値が null ではないことをコンパイラが保証できる場合にのみ、変数を逆参照できます。
  - これらの変数は、既定値 `null` で初期化される場合があり、他のコードで値 `null` を割り当てられる可能性があります。

以前のバージョンの C# では変数の宣言から設計の意図を判断できなかったので、この新機能には参照変数の処理について大きなメリットがあります。 コンパイラでは、参照型の null 参照例外に対する安全性は提供されませんでした。

- **参照は null にできる**。 参照型を null に初期化したり、後で null を割り当てたりしても、警告は発行されません。
- **参照は null ではないと見なされる**。 参照型が逆参照されても、コンパイラでは警告は発行されません。 (null 許容参照では、null の可能性がある変数を逆参照するたびに、コンパイラで警告が発行されます)。

null 許容参照型の追加により、いっそう明確に意図を宣言できます。 `null` 値は、変数で値が参照されていないことを表すための正しい方法です。 コードからすべての `null` 値を削除するために、この機能を使用しないでください。 そうではなく、コンパイラと、コードを読む他の開発者に対し、自分の意図を宣言する必要があります。 意図を宣言することにより、その意図と矛盾するコードを記述すると、コンパイラによって通知されます。

**null 許容参照型**は、[null 許容値型](language-reference/builtin-types/nullable-value-types.md)と同じ構文を使用して記述し、変数の型の後に `?` を追加します。 たとえば、次の変数宣言は、null 許容型の文字列変数 `name` を表します。

```csharp
string? name;
```

型の名前に `?` が追加されていないすべての変数は、**null 非許容参照型**です。 この機能を有効にすると、既存のコードのすべての参照型変数がそれに含まれます。

コンパイラでは、静的分析を使用して、null 許容参照が非 null として認識されているかどうかが判定されます。 コンパイラは、null の可能性があるときに null 許容参照を逆参照していると警告します。 この動作は、変数名の後に [null 免除演算子](language-reference/operators/null-forgiving.md) `!` を使用することでオーバーライドできます。 たとえば、変数 `name` は null ではないことがわかっているのに、コンパイラで警告が出る場合は、次のようにコードを記述することで、コンパイラの分析をオーバーライドできます。

```csharp
name!.Length;
```

## <a name="nullability-of-types"></a>型の null 値の許容

すべての参照型には、4 種類の "*null 値の許容*" のいずれかを指定でき、それぞれで警告が生成される場合が示されています。

- "*null 非許容*" : この型の変数には、null を割り当てることはできません。 この型の変数については、逆参照する前に null チェックを行う必要はありません。
- "*null 許容*" : この型の変数には、null を割り当てることができます。 先に `null` をチェックしないでこの型の変数を逆参照すると、警告が生成されます。
- "*無関係*" : これは、C# 8.0 より前の状態です。 この型の変数を逆参照したり割り当てたりしても、警告は発生しません。
- "*不明*" : これは一般に、型が "*null 許容*" または "*null 非許容*" でなければならないことが制約によってコンパイラに指示されない、型パラメーターの場合です。

変数宣言での型の null 値の許容は、変数が宣言されている "*null 許容コンテキスト*" によって制御されます。

## <a name="nullable-contexts"></a>null 許容コンテキスト

null 許容コンテキストでは、コンパイラによる参照型変数の解釈方法を細かく制御できます。 指定されたソース行の **null 許容注釈コンテキスト**は、有効または無効です。 C# 8.0 より前のコンパイラでは、無効な null 許容コンテキストですべてのコードがコンパイルされると考えることができます。すべての参照型は null にすることができます。 **null 許容警告コンテキスト**も有効または無効にすることができます。 null 許容警告コンテキストでは、フロー分析を使用するコンパイラによって生成される警告が指定されます。

プロジェクトの null 許容注釈コンテキストと null 許容警告コンテキストは、 *.csproj* ファイルの `Nullable` 要素を使用して設定することができます。 この要素では、コンパイラによって型の null 値の許容が解釈される方法と、生成される警告を構成します。 有効な設定は次のとおりです。

- `enable`:null 許容注釈コンテキストは**有効**です。 null 許容警告コンテキストは**有効**です。
  - 参照型の変数 (`string` など) は、null 非許容です。  null 値の許容のすべての警告は有効です。
- `warnings`:null 許容注釈コンテキストは**無効**です。 null 許容警告コンテキストは**有効**です。
  - 参照型の変数は、無関係です。 null 値の許容のすべての警告は有効です。
- `annotations`:null 許容注釈コンテキストは**有効**です。 null 許容警告コンテキストは**無効**です。
  - 参照型の変数 (文字列など) は、null 非許容です。 null 値の許容のすべての警告は無効です。
- `disable`:null 許容注釈コンテキストは**無効**です。 null 許容警告コンテキストは**無効**です。
  - 参照型の変数は無関係であり、以前のバージョンの C# と同じです。 null 値の許容のすべての警告は無効です。

**例**:

```xml
<Nullable>enable</Nullable>
```

ディレクティブを使用して、プロジェクト内の任意の場所にこれらと同じコンテキストを設定することもできます。

- `#nullable enable`:null 許容注釈コンテキストと null 許容警告コンテキストを、**有効**に設定します。
- `#nullable disable`:null 許容注釈コンテキストと null 許容警告コンテキストを、**無効**に設定します。
- `#nullable restore`:null 許容注釈コンテキストと null 許容警告コンテキストを、プロジェクトの設定に戻します。
- `#nullable disable warnings`:null 許容警告コンテキストを**無効**に設定します。
- `#nullable enable warnings`:null 許容警告コンテキストを**有効**に設定します。
- `#nullable restore warnings`:null 許容警告コンテキストをプロジェクトの設定に戻します。
- `#nullable disable annotations`:Null 許容の注釈コンテキストを**無効**に設定します。
- `#nullable enable annotations`:Null 許容の注釈コンテキストを**有効**に設定します。
- `#nullable restore annotations`:注釈の警告コンテキストをプロジェクト設定に復元します。

既定の null 許容注釈および警告コンテキストは**無効**です。 これは、既存のコードを変更せずにコンパイルできて新しい警告は生成されないことを意味します。

## <a name="nullable-annotation-context"></a>null 許容注釈コンテキスト

null 許容注釈コンテキストが無効になっていると、コンパイラでは次の規則が使用されます。

- 無効コンテキスト内で null 許容参照を宣言することはできません。
- すべての参照変数には、null を割り当てることができます。
- 参照型の変数が逆参照されても、警告は生成されません。
- 無効コンテキスト内では、null 免除演算子を使用できません。

動作は、以前のバージョンの C# と同じです。

null 許容注釈コンテキストが有効になっていると、コンパイラでは次の規則が使用されます。

- 参照型のすべての変数は、**null 非許容参照**です。
- すべての null 非許容参照は、安全に逆参照できます。
- すべての null 許容参照型 (変数宣言で型の後に `?` を付けて示されているもの) は、null にすることができます。 静的分析によって、逆参照されるときに値が null 以外であることがわかっているかどうかが決定されます。 そうでない場合、コンパイラで警告が出ます。
- null 免除演算子を使用して、null 許容参照が null ではないことを宣言できます。

null 許容注釈コンテキストが有効になっていると、参照型に追加された `?` 文字により、**null 許容参照型**が宣言されます。 **null 免除演算子** `!` を式に追加して、式が null ではないことを宣言できます。

## <a name="nullable-warning-context"></a>null 許容警告コンテキスト

null 許容警告コンテキストは、null 許容注釈コンテキストとは異なります。 新しい注釈が無効になっている場合でも、警告を有効にすることができます。 コンパイラでは、静的フロー解析を使用して、参照の **null 状態**が決定されます。 *null 許容警告コンテキスト*が**無効**ではない場合、null 状態は **null ではない**または **null かもしれない**です。 コンパイラが **null かもしれない**と判断したときに、参照を逆参照した場合は、コンパイラで警告が出ます。 コンパイラが次の 2 つの条件のいずれかであると判断できない場合、参照の状態は **null かもしれない**になります。

1. 変数に null 以外の値が確実に割り当てられている。
1. 変数または式は、それを逆参照する前に null かどうかをチェックされている。

null 許容警告コンテキストが有効の場合、**null かもしれない**状態の変数または式を逆参照すると常に、コンパイラで警告が生成されます。 さらに、有効な null 許容注釈コンテキストで、**null かもしれない**状態の変数または式を null 非許容参照型に割り当てると、警告が生成されます。

## <a name="see-also"></a>関連項目

- [null 許容参照型仕様の下書き](~/_csharplang/proposals/csharp-8.0/nullable-reference-types-specification.md)
- [null 許容参照の概要チュートリアル](tutorials/nullable-reference-types.md)
- [既存のコードベースを null 許容参照に移行する](tutorials/upgrade-to-nullable-references.md)

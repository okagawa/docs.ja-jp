---
title: リレーショナル データ ソースとNoSQL データ
description: クラウドネイティブアプリケーションでのリレーショナルデータと NoSQL データについて説明します
author: robvet
ms.date: 05/17/2020
ms.openlocfilehash: cc47faa4fcd4468de9ddc468e488297db4289ff5
ms.sourcegitcommit: 27db07ffb26f76912feefba7b884313547410db5
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/19/2020
ms.locfileid: "83613786"
---
# <a name="relational-vs-nosql-data"></a>リレーショナル データ ソースとNoSQL データ

リレーショナルと NoSQL は、クラウドネイティブアプリで一般的に実装される2種類のデータベースシステムです。 異なる方法で作成され、異なる方法でデータを格納します。 このセクションでは、両方を見ていきます。 この章の後半では、 *Newsql*という新しいデータベーステクノロジについて説明します。

*リレーショナルデータベース*は、数十年にわたり一般的なテクノロジでした。 成熟し、実証済みで、広く実装されています。 競合するデータベース製品、ツール、専門知識が豊富にあります。 リレーショナルデータベースは、関連するデータテーブルのストアを提供します。 これらのテーブルには固定スキーマがあり、SQL (構造化照会言語) を使用してデータを管理し、ACID 保証をサポートしています。

*SQL データベース*は、高パフォーマンスの非リレーショナルデータストアを参照します。 これらは、使いやすさ、スケーラビリティ、回復性、および可用性の特性を excel で実現しています。 NoSQL は、正規化されたデータのテーブルを結合するのではなく、非構造化データまたは半構造化データをキーと値のペアまたは JSON ドキュメントに格納します。 SQL データベースでは、通常、単一のデータベースパーティションのスコープを超える ACID 保証は提供されません。 Sub second 応答時間を必要とする高ボリュームサービスでは、NoSQL データストアを優先します。

分散クラウドネイティブシステムの[NoSQL](https://www.geeksforgeeks.org/introduction-to-nosql/)テクノロジの影響を数多くにすることはできません。 この領域に新しいデータテクノロジが急増すると、リレーショナルデータベースに排他的に依存するソリューションが中断されました。

NoSQL データベースには、データにアクセスして管理するための複数の異なるモデルが含まれており、それぞれが特定のユースケースに適しています。 図5-9 は、4つの一般的なモデルを示しています。

![NoSQL データモデル](./media/types-of-nosql-datastores.png)

**図 5-9**: NoSQL データベースのデータモデル

| モデル | 特性 |
| :-------- | :-------- |
| ドキュメントストア | データとメタデータは、データベース内の JSON ベースのドキュメントに階層的に格納されます。 |
| キー値のストア | 最も単純な NoSQL データベースであるデータは、キーと値のペアのコレクションとして表されます。 |
| ワイド列ストア | 関連データは、1つの列に入れ子になったキーと値のペアのセットとして格納されます。 |
| グラフストア | データは、ノード、エッジ、およびデータプロパティとしてグラフ構造に格納されます。 |

## <a name="the-cap-theorem"></a>CAP 定理

これらの種類のデータベースの違いを理解するには、CAP 定理を検討してください。これは、状態を格納する分散システムに適用される一連の原則です。 図5-10 は、キャップ定理の3つのプロパティを示しています。

![CAP 定理](./media/cap-theorem.png)

**図 5-10** CAP 定理

定理は、分散データシステムが整合性、可用性、およびパーティションの許容範囲の間にトレードオフを提供することを示しています。 また、どのデータベースでも保証できるのは、次の3つのプロパティのうち*2 つ*だけです。

- *確保.* すべてのレプリカが更新されるまで、システムが要求をブロックする必要がある場合でも、クラスター内のすべてのノードが最新のデータで応答します。 現在更新中の項目に対して "一貫性のあるシステム" を照会した場合、すべてのレプリカが正常に更新されるまで、その応答を待機します。 ただし、最新のデータを受け取ることができます。

- *可用性.* すべてのノードは、応答が最新のデータではない場合でも、直ちに応答を返します。 更新中の項目に対して "使用可能なシステム" を照会すると、その時点でサービスが提供できる最適な回答が得られます。

- *パーティションの許容範囲。* レプリケートされたデータノードで障害が発生した場合や、他のレプリケートされたデータノードとの接続が失われた場合でも、システムの動作が保証されます。

リレーショナルデータベースは通常、整合性と可用性を提供しますが、パーティションの許容範囲は提供しません。 通常は、1台のサーバーにプロビジョニングされ、コンピューターにリソースを追加して垂直方向にスケールします。

多くのリレーショナルデータベースシステムでは、プライマリデータベースのコピーを他のセカンダリサーバーインスタンスに対して実行できる、組み込みのレプリケーション機能がサポートされています。 書き込み操作は、プライマリインスタンスに対して行われ、各セカンダリにレプリケートされます。 障害が発生すると、プライマリインスタンスはセカンダリにフェールオーバーして高可用性を実現できます。 セカンダリを使用して、読み取り操作を配布することもできます。 書き込み操作は常にプライマリレプリカに対して行われますが、読み取り操作を任意のセカンダリにルーティングしてシステム負荷を減らすことができます。

データは、[シャーディング](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-scale-introduction)など、複数のノードにわたって水平方向にパーティション分割することもできます。 しかし、シャーディングは、簡単には通信できない多くのデータを spitting することによって、運用上のオーバーヘッドを劇的に増やします。 コストがかかり、管理に時間がかかることがあります。 最終的には、パフォーマンス、テーブルの結合、および参照整合性に影響を与える可能性があります。

データレプリカが "非常に一貫性のある" リレーショナルデータベースクラスターでネットワーク接続を失った場合、データベースに書き込むことはできません。 書き込み操作は、その変更を他のデータレプリカにレプリケートできないため、システムによって拒否されます。 トランザクションを完了するには、すべてのデータレプリカを更新する必要があります。

NoSQL データベースは、通常、高可用性とパーティションの許容範囲をサポートしています。 これらは、一般に汎用サーバー間で水平方向にスケールアウトされます。 このアプローチでは、地理的なリージョン内外でのコスト削減により、高可用性を実現します。 これらのマシンまたはノード間でデータをパーティション分割してレプリケートし、冗長性とフォールトトレランスを提供します。 欠点は、整合性です。 1つの NoSQL ノード上のデータに対する変更は、他のノードに反映されるまでに時間がかかることがあります。 通常、NoSQL データベースノードは、表示されているデータが古く、まだ更新されていない場合でも、クエリに対してすぐに応答を提供します。

データレプリカが "高可用性" NoSQL データベースクラスター内の接続を失った場合でも、データベースに対する書き込み操作を完了できます。 データベースクラスターでは、書き込み操作が許可され、各データレプリカが使用可能になった時点で更新されます。

このような結果は、ACID トランザクションがサポートされていない分散データシステムの特性である "最終的な整合性" と呼ばれます。 データ項目が更新されてから、その更新が各レプリカノードに反映されるまでにかかる時間が短くなります。 通常の状況では、lag は通常は短くなりますが、問題が発生すると増加する可能性があります。 たとえば、米国で NoSQL データベースの製品項目を更新し、ヨーロッパのレプリカノードから同じデータ項目を照会した場合はどうなるでしょうか。 クラスターが製品の変更によって欧州ノードを更新するまで、以前の製品情報が表示されます。 クエリ結果を直ちに返し、すべてのレプリカノードが更新されるのを待たずに、大幅なスケールとボリュームが得られますが、古いデータが表示される可能性があります。

多くの場合、高可用性と大規模なスケーラビリティは、強力な整合性よりもビジネスにとって重要です。 開発者は、Sagas、CQRS、非同期メッセージングなどの手法やパターンを実装して、最終的な整合性を実現できます。

> 今日では、CAP 定理の制約を使用する場合は注意が必要です。 NewSQL と呼ばれる新しい種類のデータベースが登場しました。これにより、リレーショナルデータベースエンジンが拡張され、水平方向のスケーラビリティと NoSQL システムのスケーラブルなパフォーマンスの両方がサポートされます。

## <a name="considerations-for-relational-vs-nosql-systems"></a>リレーショナルシステムおよび NoSQL システムに関する考慮事項

クラウドネイティブベースのマイクロサービスでは、特定のデータ要件に基づいて、リレーショナル、NoSQL データストア、またはその両方を実装できます。

|  次の場合は、NoSQL データストアを検討してください。 | 次の場合にリレーショナルデータベースを検討します。 |
| :-------- | :-------- |
| 大規模なワークロードを必要とするボリュームが多い | ワークロードボリュームは一貫しており、中規模から大規模の規模が必要 |
| ワークロードに ACID 保証は不要 |  ACID 保証が必要です |
| データは動的で頻繁に変更されます | データが予測可能で、高度に構造化されている |
| リレーションシップを使用せずにデータを表すことができます。 | データは relationally に最適です。 |  
| 高速書き込みが必要であり、書き込みの安全性が重要ではない | 書き込みの安全性が必要です |  
| データの取得は単純であり、フラットである傾向があります。 | 複雑なクエリとレポートを操作する|
| データには、地理的に広い分布が必要です | ユーザーの集中管理 |
| アプリケーションは、パブリッククラウドなどの汎用的なハードウェアにデプロイされます。 | アプリケーションは、大規模なハイエンドハードウェアにデプロイされます。 |

次のセクションでは、クラウドネイティブデータを格納および管理するために Azure クラウドで利用できるオプションについて説明します。

## <a name="database-as-a-service"></a>サービスとしてのデータベース

まず、Azure 仮想マシンをプロビジョニングし、各サービスに対して任意のデータベースをインストールすることができます。 環境を完全に制御できますが、クラウドプラットフォームの多くの組み込み機能を済ませるしています。 また、各サービスの仮想マシンとデータベースの管理も行います。 このアプローチは、短時間で時間がかかり、コストがかかる可能性があります。

代わりに、クラウドネイティブアプリケーションは、サービスとしての[データベース (DBaaS)](https://www.stratoscale.com/blog/dbaas/what-is-database-as-a-service/)として公開されるデータサービスを優先します。 クラウドベンダーによって完全に管理されています。これらのサービスには、組み込みのセキュリティ、スケーラビリティ、および監視機能が備わっています。 サービスを所有するのではなく、単にそれを[バッキングサービス](./definition.md#backing-services)として使用します。 プロバイダーは、大規模なリソースを操作し、パフォーマンスとメンテナンスの責任を担います。

高可用性を実現するために、クラウドの可用性ゾーンとリージョンで構成することができます。 これらはすべて、ジャストインタイム容量と従量課金制モデルをサポートしています。 Azure にはさまざまな種類の管理データサービスオプションがあり、それぞれに固有の利点があります。

まず、Azure で使用できるリレーショナル DBaaS サービスについて説明します。 Microsoft の主要な SQL Server データベースが、いくつかのオープンソースオプションと共に利用できることがわかります。 次に、Azure の NoSQL data サービスについて説明します。

## <a name="azure-relational-databases"></a>Azure リレーショナルデータベース

リレーショナルデータを必要とするクラウドネイティブマイクロサービスでは、図5-11 に示すように、4つのサービスとしてのリレーショナルデータベース (DBaaS) が Azure に用意されています。

![Azure での管理されたリレーショナルデータベース](./media/azure-managed-databases.png)

**図 5-11** Azure で使用可能な管理されたリレーショナルデータベース

前の図では、各が共通の DBaaS インフラストラクチャにどのように配置されているかに注目してください。これは、追加コストなしで重要な機能を提供します。

これらの機能は、多数のデータベースをプロビジョニングし、それらを管理するためのリソースが限られている組織にとって特に重要です。
Azure データベースを数分でプロビジョニングするには、処理コア、メモリ、および基になるストレージの量を選択します。 データベースを即座にスケーリングし、ダウンタイムなしでリソースを動的に調整できます。

## <a name="azure-sql-database"></a>Azure SQL データベース

Microsoft SQL Server の専門知識を持つ開発チームは、 [Azure SQL Database](https://docs.microsoft.com/azure/sql-database/)について検討する必要があります。 これは、Microsoft SQL Server データベースエンジンに基づく、完全に管理されたサービスとしてのリレーショナルデータベース (DBaaS) です。 このサービスは、オンプレミスバージョンの SQL Server で検出された多くの機能を共有し、SQL Server データベースエンジンの最新の安定したバージョンを実行します。

クラウドネイティブマイクロサービスで使用する場合は、次の3つのデプロイオプションを使用して Azure SQL Database を使用できます。

- Single Database は、Azure クラウドの[Azure SQL Database サーバー](https://docs.microsoft.com/azure/sql-database/sql-database-servers)で実行されている完全に管理された SQL Database を表します。 データベースは、基になるデータベースサーバーに構成の依存関係がないため、含まれて[*いる*](https://docs.microsoft.com/sql/relational-databases/databases/contained-databases)と見なされます。
  
- [Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance)は、オンプレミスの SQL Server とほぼ100% の互換性を提供する、Microsoft SQL Server データベースエンジンの完全に管理されたインスタンスです。 このオプションは、35 TB までの大規模なデータベースをサポートしており、分離性を高めるために[Azure Virtual Network](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview)に配置されています。

- [Azure SQL Database サーバーレス](https://docs.microsoft.com/azure/sql-database/sql-database-serverless)は、ワークロードの需要に基づいて自動的にスケーリングする単一データベースのコンピューティング層です。 1秒あたりに使用されたコンピューティングの量に対してのみ課金されます。 サービスは、断続的で予測できない使用パターンを持つワークロードに適しており、非アクティブな状態が一定期間含まれています。 また、サーバーレスコンピューティング層は、非アクティブ期間中に自動的にデータベースを一時停止して、ストレージの料金のみが課金されるようにします。 アクティビティが戻ると自動的に再開されます。

Azure では、従来の Microsoft SQL Server スタックを超えて、3つの一般的なオープンソースデータベースのマネージバージョンも機能します。

## <a name="open-source-databases-in-azure"></a>Azure でのオープンソースデータベース

オープンソースのリレーショナルデータベースは、クラウドネイティブアプリケーションでよく選択されています。 多くの企業は、特にコストを削減するために、商用データベース製品よりも優先しています。 多くの開発チームは、柔軟性、コミュニティによる開発、ツールと拡張機能のエコシステムをご利用いただけます。 オープンソースデータベースは、複数のクラウドプロバイダーにデプロイできるので、"ベンダーのロックイン" の問題を最小限に抑えることができます。

開発者は、任意のオープンソースデータベースを Azure VM 上で簡単に自己ホストできます。 この方法では、フルコントロールを提供しながら、データベースと VM の管理、監視、およびメンテナンスのためのフックを作成できます。

ただし、Microsoft は、いくつかの一般的なオープンソースデータベースを*完全に管理*された dbaas サービスとして提供することにより、Azure を "オープンプラットフォーム" にする取り組みを継続します。

### <a name="azure-database-for-mysql"></a>Azure Database for MySQL

[MySQL](https://en.wikipedia.org/wiki/MySQL)  は、オープンソースのリレーショナルデータベースであり、[ランプソフトウェアスタック](https://en.wikipedia.org/wiki/LAMP_(software_bundle))上に構築されたアプリケーションの柱です。 *読み取り負荷の高い*ワークロードでは、Facebook、Twitter、YouTube などの多くの大規模な組織で使用されています。 Community edition は無料でご利用いただけますが、enterprise edition ではライセンス購入が必要です。 当初、1995年に作成された製品は、Sun Microsystems によって2008に購入されています。 Oracle は2010で Sun と MySQL を獲得しました。

[Azure Database for MySQL](https://azure.microsoft.com/services/mysql/)は、オープンソースの MySQL サーバーエンジンに基づく管理されたリレーショナルデータベースサービスです。 MySQL Community edition を使用します。 Azure MySQL サーバーは、サービスの管理ポイントです。 これは、オンプレミスのデプロイに使用されるものと同じ MySQL サーバーエンジンです。 エンジンは、サーバーごとに1つのデータベース、またはリソースを共有するサーバーごとに複数のデータベースを作成できます。 新しいスキルを習得したり、仮想マシンを管理したりすることなく、同じオープンソースツールを使用してデータの管理を継続できます。

### <a name="azure-database-for-mariadb"></a>Azure Database for MariaDB

[MariaDB](https://mariadb.com/)サーバーは、もう1つの一般的なオープンソースのデータベースサーバーです。 これは、MySQL を所有している Oracle 購入時の MySQL の*フォーク*として作成されました。 目的は、MariaDB がオープンソースのままになっていることを確認することでした。 MariaDB は MySQL のフォークであるため、データとテーブルの定義は互換性があり、クライアントプロトコル、構造体、および Api は knit になります。

MariaDB には強力なコミュニティがあり、多くの大企業で使用されています。 Oracle は MySQL を引き続き保持、強化、サポートしていますが、MariaDB foundation は MariaDB を管理して、製品とドキュメントに公開された投稿を可能にします。

[Azure Database for MariaDB](https://azure.microsoft.com/services/mariadb/)は、Azure クラウドで完全に管理されたサービスとしてのリレーショナルデータベースです。 このサービスは、MariaDB community edition サーバーエンジンをベースにしています。 予測可能なパフォーマンスと動的なスケーラビリティを備えたミッションクリティカルなワークロードを処理できます。

### <a name="azure-database-for-postgresql"></a>Azure Database for PostgreSQL

[PostgreSQL](https://www.postgresql.org/)は、30年を超えるアクティブな開発を含むオープンソースのリレーショナルデータベースです。 Postgresql は信頼性とデータの整合性を強力に評価しています。 機能豊富な SQL に準拠しており、MySQL よりもパフォーマンスが高いと見なされます (特に、複雑なクエリや大量の書き込みがあるワークロードの場合)。 Apple、Red Hat、および富士通を含む多くの大企業は、PostgreSQL を使用して製品を構築しています。

[Azure Database for PostgreSQL](https://azure.microsoft.com/services/postgresql/)は、オープンソースの Postgres データベースエンジンに基づいた、完全に管理されたリレーショナルデータベースサービスです。 このサービスでは、C++、Java、Python、Node、C、PHP など、多くの開発プラットフォームがサポートされてい \# ます。 [コマンドラインインターフェイス](https://datamigration.microsoft.com/scenario/postgresql-to-azurepostgresql?step=1)ツールまたは Azure データ移行サービスを使用して、PostgreSQL データベースを移行することができます。

Azure Database for PostgreSQL には、次の2つの展開オプションがあります。

- [単一サーバー](https://docs.microsoft.com/azure/postgresql/concepts-servers)配置オプションは、複数のデータベースを展開できる複数のデータベースの中央管理ポイントです。 価格は、コアとストレージに基づいてサーバーごとに構造化されています。

- [ハイパースケール (Citus) オプション](https://azure.microsoft.com/blog/get-high-performance-scaling-for-your-azure-database-workloads-with-hyperscale/)は、Citus データテクノロジを利用しています。 高パフォーマンスを実現するために、1つのデータベースを数百のノードにわたって*水平方向にスケーリング*することで、パフォーマンスとスケールを高速にすることができます。 このオプションを使用すると、エンジンはメモリにより多くのデータを格納し、数百のノードにわたってクエリを並列化して、データのインデックス作成を高速化できます。

## <a name="nosql-data-in-azure"></a>Azure でのデータの NoSQL

Cosmos DB は、Azure クラウドで完全に管理された、グローバルに分散された NoSQL データベースサービスです。 これは世界中の多数の大企業で採用されており、Coca-Cola、Skype、ExxonMobil、Liberty 相互などが含まれています。

サービスが世界中のどこからでも高速な応答を必要とする場合、高可用性、または柔軟なスケーラビリティを実現するには、Cosmos DB が最適です。 図5-12 に Cosmos DB を示します。

![Cosmos DB の概要](./media/cosmos-db-overview.png)

**図 5-12**: Cosmos DB の概要

前の図は、Cosmos DB で使用できる組み込みのクラウドネイティブ機能の多くを示しています。 このセクションでは、詳しく見ていきます。

### <a name="global-support"></a>グローバル サポート

クラウドネイティブアプリケーションは、多くの場合グローバルな対象ユーザーを持ち、グローバルなスケールを必要とします。

Cosmos データベースをリージョン間または世界中に分散し、データをユーザーの近くに配置し、応答時間を短縮し、待機時間を短縮することができます。 サービスを一時停止または再デプロイすることなく、リージョンのデータベースを追加または削除できます。 バックグラウンドでは、Cosmos DB は、構成されている各リージョンにデータを透過的にレプリケートします。

Cosmos DB は、グローバルレベルで[アクティブ/アクティブ](https://kemptechnologies.com/white-papers/unfog-confusion-active-passive-activeactive-load-balancing/)クラスタリングをサポートしているため、*書き込みと読み取りの両方*をサポートするようにデータベースリージョンを構成できます。

[マルチマスター](https://docs.microsoft.com/azure/cosmos-db/multi-master-benefits)プロトコルは、次の機能を有効にする Cosmos DB の重要な機能です。

- 無制限でエラスティックな書き込みと読み取りのスケーラビリティ。

- 全世界での 99.999% の読み取りおよび書き込みの可用性。

- 99 パーセンタイルで 10 ミリ秒未満の処理性能が保証された読み取りと書き込み。

Cosmos DB[マルチホーム api](https://docs.microsoft.com/azure/cosmos-db/distribute-data-globally)を使用すると、マイクロサービスは最も近い Azure リージョンを自動的に認識し、そのリージョンに要求を送信します。 最も近いリージョンは、構成を変更せずに Cosmos DB によって識別されます。 リージョンが使用できなくなった場合、マルチホーム機能は、次に最も近い利用可能なリージョンに自動的に要求をルーティングします。

### <a name="multi-model-support"></a>マルチモデルサポート

モノリシックアプリケーションをクラウドネイティブアーキテクチャに基幹する場合、開発チームはオープンソースの NoSQL データストアの移行が必要になることがあります。 Cosmos DB は、その*マルチモデル*データプラットフォームを使用して、これらの NoSQL データストアへの投資を維持するのに役立ちます。 次の表は、サポートされている NoSQL[互換性 api](https://www.wikiwand.com/en/Cosmos_DB)を示しています。

| プロバイダー | 説明  |
| :-------- | :-------- |
| SQL API | JSON ドキュメントと SQL ベースのクエリをサポートする独自の API |
| Mongo DB API | Mongo DB Api と JSON ドキュメントをサポートしています|
| Gremlin API | グラフベースのノードとエッジデータ表現を使用して、グリーン化 API をサポートします |
| Cassandra API | Wide 列のデータ表現で Casandra API をサポート |  
| テーブル API  | Premium の機能強化による Azure Table Storage のサポート |  
| etcd API | Azure Kubernetes Service クラスターのバッキングストアとして Cosmos DB を有効にします |

開発チームは、データまたはコードへの変更を最小限に抑えながら、既存の Mongo、Cassandra、またはのデータベースを Cosmos DB に移行できます。 新しいアプリでは、開発チームはオープンソースオプションと組み込みの SQL API モデルのいずれかを選択できます。

> 内部的には、Cosmos はプリミティブデータ型で構成された単純な構造体形式でデータを格納します。 各要求に対して、データベースエンジンは、プリミティブデータを選択したモデル表現に変換します。

前の表では、 [Table API](https://docs.microsoft.com/azure/cosmos-db/table-introduction)オプションに注意してください。 この API は、Azure Table Storage の進化です。 どちらも基になる同じテーブルモデルを共有しますが、Cosmos DB Table API では Azure Storage API では利用できない premium の機能強化が追加されています。 次の表は、の機能を比較したものです。

|  | Azure Table Storage  | Azure Cosmos DB  |
| :-------- | :-------- |:-------- |
| Latency | Fast | 世界中のどこでも読み取りと書き込みのために1桁のミリ秒の待機時間 |
| スループット | テーブルあたりの操作数が2万の制限 | 1000万テーブルあたりの操作数 |
| グローバル分散 | オプションの1つのセカンダリ読み取りリージョンを持つ単一リージョン | 自動フェールオーバーを使用するすべてのリージョンへのターンキーディストリビューション |
| インデックス作成 | パーティションキーと行キーのプロパティでのみ使用できます | すべてのプロパティの自動インデックス作成 |
| 価格 | ストレージに基づく | スループットに基づく |

Azure Table storage を使用するマイクロサービスは、Cosmos DB Table API に簡単に移行できます。 コードに変更を加える必要はありません。

### <a name="tunable-consistency"></a>調整可能の一貫性

前の「*リレーショナルと NoSQL* 」セクションでは、*データの一貫性*について説明しました。 データの整合性とは、データの*整合性*を意味します。 分散データを使用したクラウドネイティブサービスはレプリケーションに依存しているため、読み取りの一貫性、可用性、待機時間の間に基本的なトレードオフを行う必要があります。

多くの分散データベースにより、開発者は、強力な整合性と最終的な整合性の2つの整合性モデルを選択できます。 *強力な一貫性*は、データプログラミングのゴールド標準です。 これにより、すべてのデータベースコピーにわたって更新がレプリケートされるのを待機する待機時間がシステムにある場合でも、常に最新のデータが返されるようになります。 *最終的な整合性を確保*するように構成されたデータベースでは、データが最新のコピーではなくてもすぐにデータが返されます。 後者のオプションを使用すると、可用性が向上し、スケールが向上し、パフォーマンスが向上します。

Azure Cosmos DB は、図5-13 に示すように、明確に定義された5つの[整合性モデル](https://docs.microsoft.com/azure/cosmos-db/consistency-levels)を提供します。

![Cosmos DB の整合性グラフ](./media/cosmos-consistency-level-graph.png)

**図 5-13**: Cosmos DB の整合性レベル

 これらのオプションを使用すると、データの一貫性、可用性、およびパフォーマンスについて、正確な選択と詳細なトレードオフを行うことができます。 レベルを次の表に示します。

| 整合性レベル | 説明  |
| :-------- | :-------- |
| Eventual | 読み取りに対する順序の保証はありません。 レプリカは最終的に収束されます。 |
| 定数プレフィックス | 読み取りは依然として最終的に行われますが、データは書き込まれた順序で返されます。 |
| セッション | 現在のセッション中に書き込まれたデータを読み取ることができることを保証します。 これは既定の整合性レベルです。 |
| Bounded Staleness | 指定した間隔で書き込みを読み取ります。 |  
| Strong  | 読み取りは、項目の最新のコミットバージョンを返すことが保証されます。 クライアントは、コミットされていないまたは部分的な読み取りを認識しません。 |  

「 [9-ボール: Cosmos DB の整合性レベル](https://blog.jeremylikness.com/blog/2018-03-23_getting-behind-the-9ball-cosmosdb-consistency-levels/)」の記事では、Microsoft プログラムマネージャー Jeremy Likness が5つのモデルについての優れた説明を提供しています。

### <a name="partitioning"></a>パーティション分割

自動[パーティション分割](https://docs.microsoft.com/azure/cosmos-db/partitioning-overview)を使用して、クラウドネイティブサービスのパフォーマンスニーズに合わせてデータベースをスケーリングする Azure Cosmos DB ます。

データベース、コンテナー、およびアイテムを作成することによって、Cosmos DB データ内のデータを管理します。

コンテナーは、Cosmos DB データベース内に存在し、スキーマに依存しないアイテムのグループを表します。 項目は、コンテナーに追加するデータです。 ドキュメント、行、ノード、またはエッジとして表されます。 コンテナーに追加されたすべての項目には、自動的にインデックスが作成されます。

コンテナーをパーティション分割するために、項目は論理パーティションと呼ばれる個別のサブセットに分割されます。 論理パーティションは、コンテナー内の各項目に関連付けられているパーティションキーの値に基づいて設定されます。 図5-14 は、パーティションキー値に基づく論理パーティションを持つ2つのコンテナーを示しています。

![Cosmos DB パーティション分割機構](./media/cosmos-db-partitioning.png)

**図 5-14**: Cosmos DB パーティション分割機構

上の図では、各項目に ' city ' または ' 空港 ' のパーティションキーが含まれていることに注意してください。 キーは、項目の論理パーティションを決定します。 都市コードを持つ項目は、左側のコンテナーと、空港コードを持つ項目が右側のコンテナーに割り当てられます。 パーティションキー値と ID 値を組み合わせると、アイテムのインデックスが作成され、アイテムが一意に識別されます。

内部的には、Cosmos DB によって、コンテナーのスケーラビリティとパフォーマンスのニーズを満たすために、物理パーティション上の[論理パーティション](https://docs.microsoft.com/azure/cosmos-db/partition-data)の配置が自動的に管理されます。 アプリケーションのスループットと記憶域の要件が増加するにつれて、Azure Cosmos DB、より多くのサーバーに対して論理パーティションを再分配します。 再配布操作は Cosmos DB によって管理され、中断やダウンタイムなしで呼び出されます。

## <a name="newsql-databases"></a>NewSQL データベース

*Newsql*  は、NoSQL の分散型スケーラビリティとリレーショナルデータベースの ACID 保証を組み合わせた、新たに導入されたデータベーステクノロジです。 NewSQL データベースは、分散環境全体で大量のデータを処理する必要があるビジネスシステムにとって重要であり、完全なトランザクションサポートと ACID 準拠を備えています。 NoSQL データベースでは大規模なスケーラビリティを実現できますが、データの整合性は保証されません。 一貫性のないデータによる断続的な問題は、開発チームに負担をかける可能性があります。 開発者は、データの不整合によって発生する問題を管理するために、マイクロサービスコードにセーフガードを構築する必要があります。

Cloud Native Computing Foundation (CNCF) には、いくつかの NewSQL database プロジェクトが用意されています。

| Project | 特性 |
| :-------- | :-------- |
| Cockroach DB |グローバルに拡張できる ACID 準拠のリレーショナルデータベース。 クラスターに新しいノードを追加すると、CockroachDB はインスタンスや地域間でデータを分散します。 信頼性を確保するために、レプリカの作成、管理、および配布を行います。 オープンソースであり、無料で利用できます。  |
| TiDB | ハイブリッドトランザクションおよび分析処理 (HTAP) ワークロードをサポートするオープンソースのデータベース。 MySQL と互換性があり、水平方向のスケーラビリティ、強力な一貫性、高可用性を備えています。  TiDB は、MySQL サーバーのように機能します。 アプリケーションに広範なコード変更を加えることなく、既存の MySQL クライアントライブラリを引き続き使用することができます。 |
| YugabyteDB | オープンソースの高パフォーマンスな分散 SQL データベース。 クエリの待機時間の短縮、障害に対する回復力、およびグローバルデータ分散がサポートされています。 YugabyteDB は PostgressSQL と互換性があり、スケールアウト RDBMS とインターネットスケールの OLTP ワークロードを処理します。 製品は NoSQL もサポートしており、Cassandra と互換性があります。 |
|Vitess | Vitess は、MySQL インスタンスの大規模なクラスターをデプロイ、スケーリング、および管理するためのデータベースソリューションです。 パブリックまたはプライベートのクラウドアーキテクチャで実行できます。 Vitess は、垂直方向と水平方向のシャーディングサポートの両方で、多くの重要な MySQL 機能と機能を組み合わせて拡張します。 YouTube により、Vitess は2011以降のすべての YouTube データベーストラフィックを処理していました。 |

前の図のオープンソースプロジェクトは、クラウドネイティブコンピューティングファンデーションから入手できます。 3つのオファリングは、.NET Core サポートを含む完全なデータベース製品です。 もう1つは、Vitess のデータベースクラスターシステムで、MySQL インスタンスの大規模なクラスターを水平方向にスケーリングします。

NewSQL データベースの主な設計目標は、プラットフォームの回復性とスケーラビリティを利用して、Kubernetes でネイティブに動作することです。

NewSQL データベースは、基になる仮想マシンをすぐに再起動または再スケジュールできる、短期クラウド環境での使用を目的として設計されています。 データベースは、データ損失やダウンタイムなしでノード障害が発生しないように設計されています。 たとえば、CockroachDB は、クラスター内のノード間でデータの一貫性のある3つのレプリカを維持することによって、コンピューターの損失に耐えられる可能性があります。

Kubernetes は、*サービス構成体*を使用して、1つの DNS エントリから、同じ newsql databases プロセスのグループに対してクライアントがアドレスを設定できるようにします。 データベースインスタンスと関連付けられているサービスのアドレスを分離することにより、既存のアプリケーションインスタンスに影響を及ぼすことなく拡張できます。 任意の時点で任意のサービスに要求を送信すると、常に同じ結果が得られます。

このシナリオでは、すべてのデータベースインスタンスが同じです。 プライマリまたはセカンダリのリレーションシップはありません。 CockroachDB で検出された*コンセンサスレプリケーション*のような手法では、任意のデータベースノードが任意の要求を処理できます。 負荷分散要求を受信するノードにローカルで必要なデータがある場合は、すぐに応答します。 それ以外の場合、ノードはゲートウェイになり、適切なノードに要求を転送して正しい回答を取得します。 クライアントの観点から見ると、すべてのデータベースノードは同じです。つまり、1つの*論理*データベースとして表示され、単一コンピューターシステムの整合性が保証されます。これには、数十または数百のノードがバックグラウンドで動作しています。

NewSQL データベースの背後にあるメカニズムの詳細については、「[ダッシュ: 4 つのプロパティ (Kubernetes-ネイティブデータベース](https://thenewstack.io/dash-four-properties-of-kubernetes-native-databases/))」を参照してください。

## <a name="data-migration-to-the-cloud"></a>クラウドへのデータ移行

時間のかかるタスクの1つは、データプラットフォーム間でデータを移行することです。 [Azure データ移行サービス](https://azure.microsoft.com/services/database-migration/)は、このような作業を迅速化するのに役立ちます。 最小限のダウンタイムで、複数の外部データベースソースから Azure データプラットフォームにデータを移行することができます。 ターゲットプラットフォームには、次のサービスが含まれます。

- Azure SQL データベース
- Azure Database for MySQL
- Azure Database for MariaDB
- Azure Database for PostgreSQL
- Cosmos DB
  
このサービスでは、小規模または大規模の移行を実行するために必要な変更を案内する推奨事項が提供されます。

>[!div class="step-by-step"]
>[前へ](distributed-data.md)
>[次へ](azure-caching.md)

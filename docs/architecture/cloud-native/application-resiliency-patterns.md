---
title: アプリケーションの回復性パターン
description: Azure 向けのクラウドネイティブ .NET アプリの設計 |アプリケーションの回復性パターン
author: robvet
ms.date: 05/13/2020
ms.openlocfilehash: bb72e47704c833a2ce86f103a66b0414ce3a37ff
ms.sourcegitcommit: 27db07ffb26f76912feefba7b884313547410db5
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/19/2020
ms.locfileid: "83614326"
---
# <a name="application-resiliency-patterns"></a>アプリケーションの回復性パターン

最初の防御ラインは、アプリケーションの回復性です。

独自の回復性フレームワークの作成にかなりの時間を費やすことができますが、このような製品は既に存在しています。 これは、開発者が堅牢性とスレッドセーフの方法で回復性ポリシーを表すことができる、包括的な .NET 復元と一時的な障害処理[ライブラリです。](http://www.thepollyproject.org/) .NET Framework または .NET Core を使用してビルドされたアプリケーションを対象にしています。 次の表では、と呼ばれる回復性機能について説明し `policies` ます。 個別に適用することも、グループ化することもできます。

| ポリシー | エクスペリエンス |
| :-------- | :-------- |
| [再試行] | 指定された操作に対する再試行操作を構成します。 |
| サーキット ブレーカー | エラーが構成されたしきい値を超えると、事前に定義された期間、要求された操作をブロックする |
| タイムアウト | 呼び出し元が応答を待機できる期間に制限を配置します。 |
| バルクヘッド | は、リソースプールの swamping からの呼び出しが失敗するのを防ぐために、固定サイズのリソースプールにアクションを制限します。 |
| キャッシュ | 応答を自動的に保存します。 |
| フォールバック | エラー発生時の構造化動作を定義します。 |

前の図では、外部クライアントとバックエンドサービスのどちらであるかにかかわらず、回復性ポリシーが要求メッセージに適用されることに注意してください。 目標は、一時的に使用できなくなる可能性があるサービスの要求を補正することです。 これらの短時間の中断は通常、次の表に示す HTTP 状態コードを使用してマニフェストに含まれます。

| HTTP 状態コード| 原因 |
| :-------- | :-------- |
| 404 | 見つかりません |
| 408 | 要求タイムアウト |
| 429 | 要求が多すぎます (おそらく、調整されている可能性があります) |
| 502 | Bad gateway |
| 503 | Service unavailable (サービス利用不可) |
| 504 | ゲートウェイのタイムアウト |

質問: HTTP 状態コード 403-許可されていないことを再試行しますか? いいえ。 ここでは、システムは正常に機能していますが、要求された操作を実行する権限がないことを呼び出し元に通知しています。 障害によって発生した操作のみを再試行する必要があります。

第1章で推奨されているように、クラウドネイティブアプリケーションを構築する Microsoft 開発者は、.NET Core プラットフォームを対象にする必要があります。 バージョン2.1 では、URL ベースのリソースと対話するための HTTP クライアントインスタンスを作成するための[HTTPClientFactory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore)ライブラリが導入されました。 ファクトリクラスは、元の HTTPClient クラスを置き換えることで、多くの強化された機能をサポートしています。その1つは、厳密な回復性ライブラリとの[緊密な統合](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md)です。 これを使用すると、アプリケーションのスタートアップクラスで復元ポリシーを簡単に定義して、部分的なエラーと接続の問題を処理することができます。

次に、再試行とサーキットブレーカーパターンについて説明します。

### <a name="retry-pattern"></a>再試行パターン

分散型クラウドネイティブ環境では、一時的な (有効期間が短い) エラーによって、サービスとクラウドリソースへの呼び出しが失敗することがあります。これは、通常、短時間の経過後に自動的に修正されます。 再試行戦略を実装することは、クラウドネイティブサービスがこれらのシナリオを軽減するのに役立ちます。

[再試行パターン](https://docs.microsoft.com/azure/architecture/patterns/retry)を使用すると、サービスは失敗した要求操作を (構成可能な) 回数指数関数的に増加する待機時間で再試行できます。 図6-2 は、アクションの再試行を示しています。

![再試行パターンのアクション](./media/retry-pattern.png)

**図 6-2**. 再試行パターンのアクション

前の図では、要求操作に対して再試行パターンが実装されています。 2秒間に最大で4回の再試行を許可するように構成されています。これは、後続の試行ごとに指数関数的に倍倍になります。

- 最初の呼び出しは失敗し、HTTP 状態コード500が返されます。 アプリケーションは2秒間待機し、呼び出しを再試行します。
- 2番目の呼び出しも失敗し、HTTP 状態コード500が返されます。 これで、アプリケーションは、バックオフ間隔を4秒に2倍にし、呼び出しを再試行します。
- 最後に、3番目の呼び出しが成功します。
- このシナリオでは、再試行操作で最大4回の再試行が試行され、呼び出しが失敗する前にバックオフ期間が2倍になりました。
- 4回目の再試行が失敗した場合、フォールバックポリシーが呼び出され、問題を適切に処理します。

サービス時間が自己修正されるように、呼び出しを再試行する前にバックオフ期間を長くすることが重要です。 最適な修正時間を実現するには、指数関数的に増加するバックオフを実装することをお勧めします (再試行ごとに期間を2倍にします)。

## <a name="circuit-breaker-pattern"></a>サーキットブレーカーパターン

再試行パターンを使用すると、部分的な障害で要求を減らすことができますが、予期しないイベントが原因でエラーが発生する可能性があります。これは、解決に長時間かかることがあります。 このような障害の重大度は、部分的な接続の損失からサービスの完全な不具合まで多岐にわたります。 このような状況では、アプリケーションが成功する可能性の低い操作を継続的に再試行することは無意味です。

問題を悪化させるために、応答しないサービスに対して継続的な再試行操作を実行すると、継続的な呼び出しによってサービスがあふれ、メモリ、スレッド、データベース接続などのリソースが枯渇し、同じリソースを使用するシステムの関連しない部分で障害が発生する可能性があります。

このような状況では、操作が直ちに失敗し、成功する可能性がある場合にのみサービスの呼び出しを試行することをお勧めします。

[サーキットブレーカーパターン](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker)を使用すると、失敗する可能性のある操作をアプリケーションが繰り返し試行するのを防ぐことができます。 事前に定義された回数の失敗した呼び出しは、サービスへのすべてのトラフィックをブロックします。 定期的に、試用版によってエラーが解決されたかどうかを判断できます。 図6-3 は、動作中のサーキットブレーカーパターンを示しています。

![サーキットブレーカーパターンの動作](./media/circuit-breaker-pattern.png)

**図 6-3**. サーキットブレーカーパターンの動作

前の図では、サーキットブレーカーパターンが元の再試行パターンに追加されています。 100要求が失敗すると、サーキットブレーカーが開き、サービスの呼び出しが許可されなくなることに注意してください。 [CheckCircuit] の値は30秒で設定され、ライブラリが1つの要求をサービスに継続することを許可する頻度を指定します。 その呼び出しが成功すると、回線が閉じられ、サービスはトラフィックに再び使用できるようになります。

サーキットブレーカーパターンの目的は、再試行パターンとは*異なる*ことに注意してください。 再試行パターンを使用すると、アプリケーションは成功すると想定して操作を再試行できます。 サーキットブレーカーパターンは、アプリケーションが失敗する可能性のある操作を実行できないようにします。 通常、アプリケーションは、サーキットブレーカーを使用して操作を呼び出す再試行パターンを使用して、これら2つのパターンを*結合*します。

## <a name="testing-for-resiliency"></a>回復性のテスト

回復性のテストは、アプリケーションの機能をテストするのと同じ方法 (単体テスト、統合テストなどを実行することによって) は常に実行することはできません。 代わりに、断続的にのみ発生する障害条件下で、エンドツーエンドのワークロードが動作する方法をテストする必要があります。 たとえば、クラッシュしたプロセス、期限切れの証明書、依存サービスを利用できないなどによってエラーを挿入します。混乱などのフレームワークは[、](https://github.com/Netflix/chaosmonkey)このような混乱テストに使用できます。

アプリケーションの回復性は、要求された問題のある操作を処理するためのものです。 しかし、これはストーリーの半分にすぎません。 次に、Azure クラウドで使用できる回復機能について説明します。

>[!div class="step-by-step"]
>[前へ](resiliency.md)
>[次へ](infrastructure-resiliency-azure.md)

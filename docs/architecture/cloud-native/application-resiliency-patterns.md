---
title: アプリケーションの回復性パターン
description: Azure 向けのクラウドネイティブ .NET アプリの設計 |アプリケーションの回復性パターン
ms.date: 06/30/2019
ms.openlocfilehash: 13811efaa88e0bd2824add1c8712b78b18d46375
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/30/2019
ms.locfileid: "73841889"
---
# <a name="application-resiliency-patterns"></a>アプリケーションの回復性パターン

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

最初の防御ラインは、ソフトウェア対応アプリケーションの回復性です。

独自の回復性フレームワークの作成にかなりの時間を費やすことができますが、このような製品は既に存在しています。 たとえば、 [polly](http://www.thepollyproject.org/) 、開発者が fluent とスレッドセーフの方法で回復性ポリシーを表すことができる、包括的な .net 復元性と一時的な障害処理ライブラリです。 コアは、完全な .NET Framework または .NET Core でビルドされたアプリケーションを対象としています。 図6-2 に、ポリシーによって提供される回復性ポリシー (つまり、機能) を示します。 これらのポリシーは、個別に適用することも、組み合わせて使用することもできます。

![Polly](./media/polly-resiliency-framework.png)

**図 6-2**。 正常性の回復性フレームワークの機能

前の図では、外部クライアントまたは別のバックエンドサービスからの要求メッセージに対して、回復性ポリシーが適用されることに注意してください。 目標は、一時的に使用できなくなる可能性があるサービスの要求を補正することです。 これらの短い中断は通常、図6-3 に示す HTTP ステータスコードを使用しています。

![再試行する HTTP 状態コード](./media/http-status-codes.png)

**図 6-3**。 再試行する HTTP 状態コード

質問: HTTP 状態コード 403-許可されていないことを再試行しますか? いいえ。 ここでは、システムは正常に機能していますが、要求された操作を実行する権限がないことを呼び出し元に通知しています。 障害によって発生した操作のみを再試行する必要があります。

第1章で推奨されているように、クラウドネイティブアプリケーションを構築する Microsoft 開発者は .NET Core をターゲットにする必要があります。 バージョン2.1 では、URL ベースのリソースと対話するための HTTP クライアントインスタンスを作成するための[HTTPClientFactory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore)ライブラリが導入されました。 ファクトリクラスは、元の HTTPClient クラスを置き換えることで、多くの強化された機能をサポートしています。その1つは、厳密な回復性ライブラリとの[緊密な統合](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md)です。 これを使用すると、アプリケーションのスタートアップクラスで復元ポリシーを簡単に定義して、部分的なエラーと接続の問題を処理することができます。

次に、再試行とサーキットブレーカーパターンについて説明します。

### <a name="retry-pattern"></a>再試行パターン

分散型クラウドネイティブ環境では、一時的な (有効期間が短い) エラーによって、サービスとクラウドリソースへの呼び出しが失敗することがあります。これは、通常、短時間の経過後に自動的に修正されます。 再試行戦略を実装すると、クラウドネイティブサービスがこれらのシナリオを処理するのに役立ちます。

[再試行パターン](https://docs.microsoft.com/azure/architecture/patterns/retry)を使用すると、サービスは失敗した要求操作を (構成可能な) 回数指数関数的に増加する待機時間で再試行できます。 図6-4 は、アクションの再試行を示しています。

![再試行パターンのアクション](./media/retry-pattern.png)

**図 6-4**。 再試行パターンのアクション

前の図では、要求操作に対して再試行パターンが実装されています。 2秒間に最大で4回の再試行を許可するように構成されています。これは、後続の試行ごとに指数関数的に倍倍になります。

- 最初の呼び出しは失敗し、HTTP 状態コード500が返されます。 アプリケーションは2秒間待機し、呼び出しを再試行します。
- 2番目の呼び出しも失敗し、HTTP 状態コード500が返されます。 これで、アプリケーションは、バックオフ間隔を4秒に2倍にし、呼び出しを再試行します。
- 最後に、3番目の呼び出しが成功します。
- このシナリオでは、再試行操作で最大4回の再試行が試行され、呼び出しが失敗する前にバックオフ期間が2倍になりました。

サービス時間が自己修正されるように、呼び出しを再試行する前にバックオフ期間を長くすることが重要です。 最適な修正時間を実現するには、指数関数的に増加するバックオフを実装することをお勧めします (再試行ごとに期間を2倍にします)。

## <a name="circuit-breaker-pattern"></a>サーキットブレーカーパターン

再試行パターンを使用すると、部分的な障害で要求を減らすことができますが、予期しないイベントが原因でエラーが発生する可能性があります。これは、解決に長時間かかることがあります。 このような障害の重大度は、部分的な接続の損失からサービスの完全な不具合まで多岐にわたります。 このような状況では、アプリケーションが成功する可能性の低い操作を継続的に再試行することは無意味です。

問題を悪化させるために、応答しないサービスに対して連続した再試行操作を実行することで、セルフサービスのサービス拒否シナリオに移行することができます。このシナリオでは、メモリ、スレッド、データベースなどの継続的な呼び出しによってサービスが大量に消費されます。接続により、同じリソースを使用するシステムの関連部分でエラーが発生します。

このような状況では、操作が直ちに失敗し、成功する可能性がある場合にのみサービスの呼び出しを試行することをお勧めします。

[サーキットブレーカーパターン](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker)を使用すると、失敗する可能性のある操作をアプリケーションが繰り返し試行するのを防ぐことができます。 また、アプリケーションを定期的に評価して、エラーが解決されたかどうかを判断するための呼び出しを監視します。 図6-5 は、動作中のサーキットブレーカーパターンを示しています。

![サーキットブレーカーパターンの動作](./media/circuit-breaker-pattern.png)

**図 6-5**。 サーキットブレーカーパターンの動作

前の図では、サーキットブレーカーパターンが元の再試行パターンに追加されています。 失敗した要求が10回失敗すると、サーキットブレーカーが開き、サービスの呼び出しが許可されなくなることに注意してください。 [CheckCircuit] の値は30秒で設定され、ライブラリが1つの要求をサービスに継続することを許可する頻度を指定します。 その呼び出しが成功すると、回線が閉じられ、サービスはトラフィックに再び使用できるようになります。

サーキットブレーカーパターンの目的は、再試行パターンとは*異なる*ことに注意してください。 再試行パターンを使用すると、アプリケーションは成功すると想定して操作を再試行できます。 サーキットブレーカーパターンは、アプリケーションが失敗する可能性のある操作を実行できないようにします。 多くの場合、アプリケーションは、サーキットブレーカーを介して操作を呼び出すために再試行パターンを使用して、これら2つのパターンを*結合*します。 ただし、再試行ロジックは、サーキットブレーカーによって返される例外に依存し、障害が一時的でないことをサーキットブレーカーが示す場合は再試行を破棄する必要があります。

アプリケーションの回復性は、要求された問題のある操作を処理するためのものです。 しかし、これはストーリーの半分にすぎません。 次に、Azure クラウドで使用できる回復機能について説明します。

>[!div class="step-by-step"]
>[前へ](resiliency.md)
>[次へ](infrastructure-resiliency-azure.md)
